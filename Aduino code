#include <WiFiS3.h>
#include <WiFiClient.h>
#include <Servo.h>

// Wi-Fi 네트워크 정보
const char* ssid = "ROBOT1_2G";

// 서버 정보
const char* serverHost = "192.168.3.15"; // 파이썬 서버의 IP
const uint16_t serverPort = 3000;       // 파이썬 서버의 포트

// TCP 클라이언트 객체
WiFiClient client;

// 모터1 서보모터 객체
Servo motor1;

// --- AMR 통신을 위한 핀 정의 ---
const int MACRO1_PIN = 2; // 매크로1 신호 (출력)
const int MACRO2_PIN = 3; // 매크로2 신호 (출력)
const int MACRO3_PIN = 11; // 매크로3 신호 (출력)
const int MACRO4_PIN = 12; // 매크로4 신호 (출력)
const int MACRO_COMP_PIN = 8; // macro_comp 신호 (입력)

// --- 모터 제어를 위한 핀 정의 (Arduino UNO R4 WiFi에 맞춤) ---
const int MOTOR1_PIN = 9; // 모터1 서보모터 제어 핀 (PWM 핀)

// 모터2 DC모터 제어 핀 (L298N 모터 드라이버 가정)
const int MOTOR2_FORWARD1_PIN = 5; // 모터2 정회전 핀 1
const int MOTOR2_FORWARD2_PIN = 6; // 모터2 정회전 핀 2
const int MOTOR2_REVERSE1_PIN = 4; // 모터2 역회전 핀 1
const int MOTOR2_REVERSE2_PIN = 7; // 모터2 역회전 핀 2
const int up = 60;
const int mid = 90;
const int down = 120;

//--- 디버그 출력 함수 ---
void debugPrint(const String &msg) {
  if (Serial) {
    Serial.println(msg);
  }
}

// --- 함수 선언 ---
void runFullProcess(String msg);
void connectToWiFi();
void connectToServer();
void sendAmrSignal(int pin);
void waitForAmrSignal();
void controlMotor2(int direction,int delay_ms);
void stopMotor2();
void receive_cont();
void give_cont();
void receive_car();
void give_car();
void controlmotor1(int angle);

void setup() {
  Serial.begin(115200);

  // --- AMR 통신 핀 모드 설정 ---
  pinMode(MACRO1_PIN, OUTPUT);
  pinMode(MACRO2_PIN, OUTPUT);
  pinMode(MACRO3_PIN, OUTPUT);
  pinMode(MACRO4_PIN, OUTPUT);
  pinMode(MACRO_COMP_PIN, INPUT_PULLUP);

  // --- 모터 핀 모드 설정 ---
  motor1.attach(MOTOR1_PIN);

  pinMode(MOTOR2_FORWARD1_PIN, OUTPUT);
  pinMode(MOTOR2_FORWARD2_PIN, OUTPUT);
  pinMode(MOTOR2_REVERSE1_PIN, OUTPUT);
  pinMode(MOTOR2_REVERSE2_PIN, OUTPUT);

  connectToWiFi();
  connectToServer();
}

void loop() {
  if (!client.connected()) {
    connectToServer();
  }
  if (client.available()) {
    String msg = client.readStringUntil('\n');
    msg.trim();
    if (msg.length() > 0) {
      client.println("ACK:" + msg);
      runFullProcess(msg);
    }
  }
}

void runFullProcess(String msg) {
  
  if (msg == "recv_cont") {
    controlmotor1(mid); // 초기화
    sendAmrSignal(MACRO1_PIN);
    client.println("AMR_SIGNAL_SENT:macro1");
    waitForAmrSignal(); // 블로킹 함수
    receive_cont();
  }
  if (msg == "white_con_give") {
    debugPrint("Step 4: Running motor2 in reverse for 3 seconds.");
    controlMotor2(-1,3500);
    client.println("MOTOR2:reverse_3s");
    client.println("receive2_ready");
  }

  if (msg == "black_con_give") {
    debugPrint("Step 7: Running motor2 in reverse for 1.5 seconds.");
    controlMotor2(-1,2000);
    client.println("MOTOR2:reverse_1_5s");
    debugPrint("Step 8: Tilting motor1 back to 90 degrees.");
    controlmotor1(mid);
    delay(1000);
    client.println("MOTOR1:90");
    debugPrint("receive_cont() function completed.");
    sendAmrSignal(MACRO2_PIN);
    client.println("AMR_SIGNAL_SENT:macro2");
    waitForAmrSignal(); // 블로킹 함수
    give_cont();
  }

  if (msg == "black_con_comp") {
    client.println("Step 5: Running motor2 forward for 3.5 seconds.");
    controlMotor2(1,6000);
    client.println("MOTOR2:forward_3s");
    client.println("give2_ready");
  }

  if (msg == "white_con_comp") {
    client.println("Step 8: Tilting motor1 back to 90 degrees.");
    controlmotor1(mid);
    delay(1000);
    client.println("MOTOR1:90");
    debugPrint("give_cont() function completed.");
  }

  if (msg == "ready_car") {
    receive_car();
    
    delay(3000);
  }

  if (msg == "car1_give") {
    debugPrint("Step 4: Running motor2 in reverse for 3 seconds.");
    controlMotor2(-1,3000);
    client.println("MOTOR2:reverse_3s");
    client.println("car2_receive_ready");
  }

  if (msg == "car2_give") {
    debugPrint("Step 7: Running motor2 in reverse for 1.5 seconds.");
    controlMotor2(-1,2000);
    client.println("MOTOR2:reverse_1_5s");
    debugPrint("Step 8: Tilting motor1 back to 90 degrees.");
    controlmotor1(mid);
    delay(1000);
    client.println("MOTOR1:90");
    debugPrint("receive_car() function completed.");
    sendAmrSignal(MACRO3_PIN);
    client.println("AMR_SIGNAL_SENT:macro3");
    waitForAmrSignal(); // 블로킹 함수
    give_car();
  }

  if (msg == "car1_comp") {
    debugPrint("Step 5: Running motor2 forward for 3 seconds.");
    controlMotor2(1,6000);
    client.println("MOTOR2:forward_3s");
    client.println("car2_ready");
  }

  if (msg == "car2_comp") {
    debugPrint("Step 8: Tilting motor1 back to 90 degrees.");
    controlmotor1(mid);
    delay(1000);
    client.println("MOTOR1:90");
    debugPrint("give_car() function completed.");
    sendAmrSignal(MACRO4_PIN);
    client.println("AMR_SIGNAL_SENT:macro4");
    waitForAmrSignal(); // 블로킹 함수
    client.println("ALL_PROCESS_COMPLETED");
  }
}

void sendAmrSignal(int pin) {
  digitalWrite(pin, HIGH);
  delay(500);
  digitalWrite(pin, LOW);
}

void waitForAmrSignal() {
  debugPrint("Waiting for 'macro_comp' signal from AMR on pin: " + String(MACRO_COMP_PIN));
  client.println("Waiting for 'macro_comp' signal from AMR on pin: " + String(MACRO_COMP_PIN));
  while (digitalRead(MACRO_COMP_PIN) == HIGH) {
    delay(200); // 대기 시간을 200ms로 늘렸습니다.
  }
  
  debugPrint("Correct signal received. Proceeding.");
  client.println("Correct signal received. Proceeding.");
  while (digitalRead(MACRO_COMP_PIN) == LOW) {
    delay(200); // 대기 시간을 200ms로 늘렸습니다.
  }
}

void controlMotor2(int direction, int delay_ms) {
  if (direction == 1) { // 정회전
    digitalWrite(MOTOR2_REVERSE1_PIN, LOW);
    digitalWrite(MOTOR2_REVERSE2_PIN, LOW);
    digitalWrite(MOTOR2_FORWARD1_PIN, HIGH);
    digitalWrite(MOTOR2_FORWARD2_PIN, HIGH);
  } else if (direction == -1) { // 역회전
    digitalWrite(MOTOR2_FORWARD1_PIN, LOW);
    digitalWrite(MOTOR2_FORWARD2_PIN, LOW);
    digitalWrite(MOTOR2_REVERSE1_PIN, HIGH);
    digitalWrite(MOTOR2_REVERSE2_PIN, HIGH);
  } else {
    digitalWrite(MOTOR2_FORWARD1_PIN, LOW);
    digitalWrite(MOTOR2_FORWARD2_PIN, LOW);
    digitalWrite(MOTOR2_REVERSE1_PIN, LOW);
    digitalWrite(MOTOR2_REVERSE2_PIN, LOW);
  }
  delay(delay_ms);
  stopMotor2();
}

void controlmotor1(int angle){
  motor1.write(angle);
}

void stopMotor2() {
  digitalWrite(MOTOR2_FORWARD1_PIN, LOW);
  digitalWrite(MOTOR2_FORWARD2_PIN, LOW);
  digitalWrite(MOTOR2_REVERSE1_PIN, LOW);
  digitalWrite(MOTOR2_REVERSE2_PIN, LOW);
}

void connectToWiFi() {
  debugPrint("Connecting to WiFi...");
  WiFi.begin(ssid);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    debugPrint("Connecting...");
  }
  debugPrint("WiFi connected!");
  debugPrint("IP Address: " + WiFi.localIP().toString());
}

void connectToServer() {
  while (!client.connect(serverHost, serverPort)) {
    debugPrint("Connection to server failed. Retrying in 3 seconds...");
    delay(3000);
  }
  debugPrint("Connected to server successfully!");

  String role = "ROLE_ARDUINO\n"; 
  client.write(role.c_str(), role.length());
  debugPrint("Sent role to server: " + role);
}

void receive_cont() {
  debugPrint("Executing receive_cont() function.");
  debugPrint("Step 1: Tilting motor1 backward to 70 degrees.");
  controlmotor1(up);
  delay(1000);
  debugPrint("Step 2: Sending 'receive1_ready' to server.");
  client.println("receive1_ready");
}

void give_cont() {
  debugPrint("Executing give_cont() function.");
  debugPrint("Step 1: Tilting motor1 forward to 110 degrees.");
  controlmotor1(down);
  delay(1000);
  debugPrint("Step 2: Running motor2 forward for 1.5 seconds.");
  controlMotor2(1,3000);
  client.println("MOTOR2:forward_1_5s");
  client.println("give1_ready");
}

void receive_car() {
  debugPrint("Executing receive_car() function.");
  debugPrint("Step 1: Tilting motor1 backward to 70 degrees.");
  controlmotor1(up);
  delay(1000);
  client.println("MOTOR1:105");
  client.println("car1_receive_ready");
}

void give_car() {
  debugPrint("Executing give_car() function.");
  debugPrint("Step 1: Tilting motor1 forward to 110 degrees.");
  controlmotor1(down);
  delay(1000);
  debugPrint("Step 2: Running motor2 forward for 1.5 seconds.");
  controlMotor2(1,2500);
  client.println("MOTOR2:forward_1_5s");
  client.println("car1_ready");
}
